<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengaluru Lake Monitor</title>
    <style>
        /* CSS Styles for the Dashboard */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        
        .dashboard-card { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            width: 400px; 
            text-align: center; 
        }

        h1 { color: #2c3e50; font-size: 24px; margin-bottom: 5px; }
        .subtitle { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }

        .status-badge { 
            display: inline-block; 
            padding: 8px 20px; 
            border-radius: 50px; 
            font-weight: bold; 
            color: white; 
            background-color: #95a5a6; /* Default Grey */
            margin-bottom: 25px;
        }

        .data-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 15px 0; 
            border-bottom: 1px solid #eee; 
        }
        
        .label { color: #7f8c8d; font-weight: 500; }
        .value { font-weight: bold; color: #2c3e50; }

        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 8px; 
            font-size: 16px; 
            cursor: pointer; 
            margin-top: 30px; 
            transition: background 0.3s;
        }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>

    <div class="dashboard-card">
        <h1 id="lakeName">Lake Monitor</h1>
        <div class="subtitle">Real-time Satellite Analysis</div>

        <div id="statusBadge" class="status-badge">Waiting for Data...</div>

        <div class="data-row">
            <span class="label">Water Area</span>
            <span id="area" class="value">---</span>
        </div>

        <div class="data-row">
            <span class="label">Turbidity Index (NDTI)</span>
            <span id="ndti" class="value">---</span>
        </div>

        <div class="data-row" style="border-bottom: none;">
            <span class="label">Data Source</span>
            <span id="source" class="value">---</span>
        </div>

        <button onclick="updateSatelliteData()" style="background-color: #8e44ad; margin-bottom: 10px;">üì° Fetch Latest Satellite Image</button>
        <button onclick="fetchAnalysis()">üìä Analyze Current Data</button>
    </div>

    <script>
        // FUNCTION 1: Download new image from Google
        async function updateSatelliteData() {
            const btn = document.querySelector("button[onclick='updateSatelliteData()']");
            const badge = document.getElementById("statusBadge");
            
            btn.textContent = "Downloading from Google Earth Engine...";
            btn.disabled = true;
            badge.textContent = "Downloading...";
            badge.style.backgroundColor = "#95a5a6";

            try {
                const response = await fetch("http://127.0.0.1:8000/update-satellite-data");
                const data = await response.json();
                
                if (data.status === "success") {
                    alert("‚úÖ Success! New satellite image downloaded.");
                    // Automatically run analysis after download
                    fetchAnalysis();
                } else {
                    alert("‚ùå Error: " + data.message);
                }
            } catch (error) {
                alert("Connection Error");
            }
            
            btn.textContent = "üì° Fetch Latest Satellite Image";
            btn.disabled = false;
        }

        // FUNCTION 2: Analyze the downloaded image
        async function fetchAnalysis() {
            const btn = document.querySelector("button[onclick='fetchAnalysis()']");
            const badge = document.getElementById("statusBadge");
            
            btn.textContent = "Processing...";
            btn.disabled = true;

            try {
                const response = await fetch("http://127.0.0.1:8000/analyze/hebbal");
                const data = await response.json();

                if (data.error) {
                    badge.textContent = "No Data Found";
                    badge.style.backgroundColor = "#e74c3c";
                    alert(data.error);
                } else {
                    document.getElementById("lakeName").textContent = data.lake_name;
                    document.getElementById("area").textContent = data.area_hectares + " Hectares";
                    document.getElementById("ndti").textContent = data.avg_ndti;
                    document.getElementById("source").textContent = data.data_source;

                    badge.textContent = "Status: " + data.status;
                    if (data.status === "Clear") {
                        badge.style.backgroundColor = "#27ae60";
                        badge.style.color = "white";
                        badge.style.border = "none";
                    } else {
                        badge.style.backgroundColor = "white";
                        badge.style.color = "#2c3e50";
                        badge.style.border = "2px solid #2c3e50";
                    }
                }
            } catch (error) {
                console.error("Error:", error);
            }
            btn.textContent = "üìä Analyze Current Data";
            btn.disabled = false;
        }
        
        // Load analysis on open
        fetchAnalysis();
    </script>
</body>
</html>