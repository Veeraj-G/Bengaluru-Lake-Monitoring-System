<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengaluru Lake Command Center</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <div id="map"></div>

    <div id="dashboardPanel" class="dashboard-panel">
        <button class="close-btn" onclick="closePanel()">&times;</button>
        
        <h1 id="lakeName">Lake Selector</h1>
        <div class="subtitle">Command Center v1.0</div>

        <div id="statusBadge" class="status-badge">Standby</div>

        <div id="insightBox" class="insight-box">
            <span style="color:#e94560; font-weight:bold;">Insight:</span>
            <span id="conclusionText">Awaiting command...</span>
        </div>

        <div class="data-header">
            <span>Parameter</span>
            <span>Detected</span>
            <span>Normal</span>
        </div>

        <div class="data-row">
            <span class="label">Water Area</span>
            <span id="area" class="value">---</span>
            <span class="standard">Dynamic</span>
        </div>
        <div class="data-row">
            <span class="label">Surface Temp</span>
            <span id="lst" class="value" style="color:#e67e22;">---</span>
            <span class="standard">&lt; 27¬∞C</span>
        </div>
        <div class="data-row">
            <span class="label">Turbidity (NDTI)</span>
            <span id="ndti" class="value">---</span>
            <span class="standard">&lt; 0.1</span>
        </div>
        <div class="data-row">
            <span class="label">Chlorophyll</span>
            <span id="ndci" class="value">---</span>
            <span class="standard">&lt; 0.1</span>
        </div>
        <div class="data-row" style="border-bottom: none;">
            <span class="label">Algal Bloom</span>
            <span id="mci" class="value">---</span>
            <span class="standard">&lt; 0.05</span>
        </div>

        <button onclick="fetchAnalysis()" id="analyzeBtn" style="display:none;">Initialize Scan</button>
        <button onclick="updateSatelliteData()" id="updateBtn" class="btn-secondary" style="display:none;">Acquire Satellite Link</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. INITIALIZE MAP ---
        var bounds = [[12.834012, 77.460102], [13.143664, 77.784143]];

        var map = L.map('map', {
            maxBounds: bounds,
            minZoom: 11,
            zoomControl: false 
        }).setView([12.98, 77.60], 12);

        var legend = L.control({ position: "bottomright" });

        legend.onAdd = function(map) {
        var div = L.DomUtil.create("div", "legend");
        
        // We use 'display: flex' to force the box and text to align perfectly
        var itemStyle = 'display: flex; align-items: center; margin-bottom: 5px;';
        var boxStyle = 'width: 18px; height: 18px; margin-right: 8px; border-radius: 3px; display: inline-block;';

        div.innerHTML += '<h4 style="margin: 0 0 10px 0; font-family: Arial; font-size: 14px;">Health Status</h4>';
        
        // Row 1: High Risk
        div.innerHTML += `<div style="${itemStyle}">
                            <span style="${boxStyle} background: #ff0000;"></span>
                            <span style="font-family: Arial; font-size: 12px;">High Algae Risk</span>
                            </div>`;

        // Row 2: Healthy
        div.innerHTML += `<div style="${itemStyle}">
                            <span style="${boxStyle} background: #28a745;"></span>
                            <span style="font-family: Arial; font-size: 12px;">Healthy Water</span>
                            </div>`;

        // Row 3: Water Body
        div.innerHTML += `<div style="${itemStyle}">
                            <span style="${boxStyle} background: #007bff;"></span>
                            <span style="font-family: Arial; font-size: 12px;">Water Body</span>
                            </div>`;
        
        div.innerHTML += '<hr style="margin: 8px 0;"><small style="font-family: Arial; color: #666;"><i>Updated: Real-Time</i></small>';

        return div;
        };

        legend.addTo(map);

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        // --- 2. DEFINE LAKES (Standard Pins) ---
        const lakes = [
            { name: "Hebbal Lake", lat: 13.0456, lng: 77.5833, id: "hebbal", active: true },
            { name: "Bellandur Lake", lat: 12.936, lng: 77.666, id: "bellandur", active: false },
            { name: "Ulsoor Lake", lat: 12.983, lng: 77.622, id: "ulsoor", active: false }
        ];

        // --- 3. HANDLE INTERACTIONS ---
        const panel = document.getElementById("dashboardPanel");

        function closePanel() {
            panel.classList.remove("panel-visible");
        }

        lakes.forEach(lake => {
            var marker = L.marker([lake.lat, lake.lng]).addTo(map);
            
            marker.bindTooltip(lake.name, {
                permanent: false, 
                direction: 'top'
            });

            marker.on('click', function() {
                panel.classList.add("panel-visible");
                document.getElementById("lakeName").textContent = lake.name;
                
                // Reset to "---"
                document.getElementById("area").textContent = "---";
                document.getElementById("lst").textContent = "---";
                document.getElementById("ndti").textContent = "---";
                document.getElementById("ndci").textContent = "---";
                document.getElementById("mci").textContent = "---";

                if (lake.active) {
                    document.getElementById("statusBadge").textContent = "TARGET LOCKED";
                    document.getElementById("statusBadge").style.backgroundColor = "#2980b9";
                    document.getElementById("conclusionText").textContent = "Target acquired. Ready to initiate satellite analysis.";
                    document.getElementById("insightBox").style.display = "block";
                    document.getElementById("analyzeBtn").style.display = "block";
                    document.getElementById("updateBtn").style.display = "block";
                } else {
                    document.getElementById("statusBadge").textContent = "OFFLINE";
                    document.getElementById("statusBadge").style.backgroundColor = "#95a5a6";
                    document.getElementById("conclusionText").textContent = "Telemetry offline. Pipeline under construction.";
                    document.getElementById("insightBox").style.display = "block";
                    document.getElementById("analyzeBtn").style.display = "none";
                    document.getElementById("updateBtn").style.display = "none";
                }

                map.flyTo([lake.lat, lake.lng], 14, { duration: 1.5 });
            });
        });

        // --- 4. BACKEND LOGIC ---
        
        // BUTTON 1: ACQUIRE SATELLITE LINK
        async function updateSatelliteData() {
            const btn = document.querySelector("#updateBtn");
            const badge = document.getElementById("statusBadge");
            
            btn.innerHTML = "üõ∞Ô∏è Connecting...";
            btn.disabled = true; 
            
            badge.textContent = "DOWNLOADING...";
            badge.style.backgroundColor = "#e67e22"; 

            try {
                const response = await fetch("http://127.0.0.1:8000/update-satellite-data");
                const data = await response.json();
                
                if (data.status === "success") {
                    btn.innerHTML = "‚úÖ Link Established";
                    btn.style.background = "#28a745"; 
                    
                    badge.textContent = "DATA READY";
                    badge.style.backgroundColor = "#2980b9"; 
                    
                    alert("Satellite Link Established!\nNew Sentinel-2 & Landsat-9 data acquired.\n\nPlease click 'INITIALIZE SCAN' to process.");
                } else {
                    alert("Error: " + data.message);
                    resetAcquireButton(btn);
                }
            } catch (error) { 
                console.error(error);
                alert("Signal Lost (Backend seems offline). Is main.py running?");
                resetAcquireButton(btn);
            }
        }

        function resetAcquireButton(btn) {
            btn.innerHTML = "Acquire Satellite Link";
            btn.disabled = false;
            btn.style.background = "#1f4068"; 
            document.getElementById("statusBadge").textContent = "TARGET LOCKED";
        }

        // BUTTON 2: INITIALIZE SCAN
        async function fetchAnalysis() {
            const btn = document.querySelector("#analyzeBtn");
            const badge = document.getElementById("statusBadge");
            
            btn.innerHTML = "üîÑ Processing...";
            btn.disabled = true;
            
            try {
                const response = await fetch("http://127.0.0.1:8000/analyze/hebbal");
                const data = await response.json();

                if (data.error) {
                    badge.textContent = "ERROR";
                    badge.style.backgroundColor = "#e74c3c";
                    alert("Analysis Failed: " + data.error);
                } else {
                    document.getElementById("area").textContent = data.area_hectares + " Ha";
                    document.getElementById("lst").textContent = data.avg_lst + " ¬∞C"; 
                    document.getElementById("ndti").textContent = data.avg_ndti;
                    document.getElementById("ndci").textContent = data.avg_ndci;
                    document.getElementById("mci").textContent = data.avg_mci;

                    badge.textContent = data.status.toUpperCase();
                    
                    let color = "#95a5a6";
                    if (data.status === "Clear") color = "#27ae60";       
                    else if (data.status.includes("High")) color = "#e74c3c"; 
                    else color = "#f1c40f"; 

                    badge.style.backgroundColor = color;
                    document.getElementById("conclusionText").innerHTML = data.conclusion;
                    
                    btn.innerHTML = "‚úÖ SCAN COMPLETE";
                    setTimeout(() => { 
                        btn.innerHTML = "Re-Initialize Scan"; 
                        btn.disabled = false; 
                    }, 3000);
                }
            } catch (error) { 
                console.error(error); 
                btn.innerHTML = "‚ùå Error";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>