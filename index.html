<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengaluru Lake Command Center</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; overflow: hidden; }
        
        /* 1. FULL SCREEN MAP */
        #map {
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }

        /* 2. FLOATING DASHBOARD PANEL */
        .dashboard-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 380px;
            background: rgba(22, 33, 62, 0.98); 
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2c3e50;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 1000;
            color: white;
            
            /* Animation */
            transform: translateX(-150%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .panel-visible {
            transform: translateX(0);
        }

        /* --- FIXED & IMPROVED CLOSE BUTTON --- */
        .close-btn {
            position: absolute;
            top: 15px;       
            right: 15px;     
            width: 35px;     /* Defined Width */
            height: 35px;    /* Defined Height */
            background: rgba(255, 255, 255, 0.1); /* Subtle background */
            border-radius: 50%; /* Perfect Circle */
            border: none;
            color: #bdc3c7;
            font-size: 24px; 
            line-height: 35px; /* Vertically Center text */
            text-align: center;
            cursor: pointer;
            z-index: 1001;
            padding: 0;
            transition: all 0.2s ease;
        }
        .close-btn:hover { 
            background: #e94560; /* Red Background on Hover */
            color: white;
            transform: rotate(90deg); /* Cool spin effect */
        }

        /* Adjusted Title to avoid overlap */
        h1 { 
            color: #e94560; 
            font-size: 22px; 
            margin: 5px 0 5px 0; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            padding-right: 40px; /* Space for the button */
        }
        
        .subtitle { color: #a0a0a0; font-size: 11px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }

        .status-badge { 
            display: inline-block; 
            padding: 6px 15px; 
            border-radius: 4px; 
            font-size: 12px;
            font-weight: bold; 
            color: white; 
            background-color: #535c68; 
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .insight-box {
            background-color: #0f3460;
            border-left: 4px solid #e94560;
            color: #ecf0f1;
            padding: 12px;
            margin-bottom: 20px;
            text-align: left;
            font-size: 13px;
            border-radius: 4px;
            line-height: 1.4;
            display: none; 
        }

        .data-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px solid #1f4068; 
        }
        
        .label { color: #bdc3c7; font-size: 0.9em;}
        .value { font-weight: bold; color: #fff; font-family: 'Consolas', monospace; }

        button { 
            background: #e94560; color: white; border: none; padding: 12px; 
            border-radius: 5px; font-size: 13px; cursor: pointer; margin-top: 15px; 
            width: 100%; transition: background 0.3s; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;
        }
        button:hover { background: #c0392b; }
        .btn-secondary { background-color: #1f4068; margin-top: 10px;}
        .btn-secondary:hover { background-color: #162447; }

        /* Custom Popup Style */
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: white;
            border-radius: 5px;
            font-family: 'Segoe UI', sans-serif;
        }
        .leaflet-popup-tip { background: #16213e; }

        /* Legend Box Styling */
        .legend {
            background: white;
            padding: 12px;
            line-height: 1.5;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="dashboardPanel" class="dashboard-panel">
        <button class="close-btn" onclick="closePanel()">&times;</button>
        
        <h1 id="lakeName">Lake Selector</h1>
        <div class="subtitle">Command Center v1.0</div>

        <div id="statusBadge" class="status-badge">Standby</div>

        <div id="insightBox" class="insight-box">
            <span style="color:#e94560; font-weight:bold;">Insight:</span>
            <span id="conclusionText">Awaiting command...</span>
        </div>

        <div class="data-row">
            <span class="label">Water Area</span>
            <span id="area" class="value">---</span>
        </div>
        <div class="data-row">
            <span class="label">Surface Temp (LST)</span>
            <span id="lst" class="value" style="color:#e67e22;">---</span>
        </div>
        <div class="data-row">
            <span class="label">Turbidity (NDTI)</span>
            <span id="ndti" class="value">---</span>
        </div>
        <div class="data-row">
            <span class="label">Chlorophyll (NDCI)</span>
            <span id="ndci" class="value">---</span>
        </div>
        <div class="data-row" style="border-bottom: none;">
            <span class="label">Algal Bloom (MCI)</span>
            <span id="mci" class="value">---</span>
        </div>

        <button onclick="fetchAnalysis()" id="analyzeBtn" style="display:none;">Initialize Scan</button>
        <button onclick="updateSatelliteData()" id="updateBtn" class="btn-secondary" style="display:none;">Acquire Satellite Link</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. INITIALIZE MAP ---
        var bounds = [[12.834012, 77.460102], [13.143664, 77.784143]];

        var map = L.map('map', {
            maxBounds: bounds,
            minZoom: 11,
            zoomControl: false 
        }).setView([12.98, 77.60], 12);

        var legend = L.control({ position: "bottomright" });

        legend.onAdd = function(map) {
        var div = L.DomUtil.create("div", "legend");
        
        // We use 'display: flex' to force the box and text to align perfectly
        var itemStyle = 'display: flex; align-items: center; margin-bottom: 5px;';
        var boxStyle = 'width: 18px; height: 18px; margin-right: 8px; border-radius: 3px; display: inline-block;';

        div.innerHTML += '<h4 style="margin: 0 0 10px 0; font-family: Arial; font-size: 14px;">Health Status</h4>';
        
        // Row 1: High Risk
        div.innerHTML += `<div style="${itemStyle}">
                            <span style="${boxStyle} background: #ff0000;"></span>
                            <span style="font-family: Arial; font-size: 12px;">High Algae Risk</span>
                            </div>`;

        // Row 2: Healthy
        div.innerHTML += `<div style="${itemStyle}">
                            <span style="${boxStyle} background: #28a745;"></span>
                            <span style="font-family: Arial; font-size: 12px;">Healthy Water</span>
                            </div>`;

        // Row 3: Water Body
        div.innerHTML += `<div style="${itemStyle}">
                            <span style="${boxStyle} background: #007bff;"></span>
                            <span style="font-family: Arial; font-size: 12px;">Water Body</span>
                            </div>`;
        
        div.innerHTML += '<hr style="margin: 8px 0;"><small style="font-family: Arial; color: #666;"><i>Updated: Real-Time</i></small>';

        return div;
        };

        legend.addTo(map);

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        // --- 2. DEFINE LAKES ---
        const lakes = [
            { name: "Hebbal Lake", lat: 13.0456, lng: 77.5833, id: "hebbal", active: true },
            { name: "Bellandur Lake", lat: 12.936, lng: 77.666, id: "bellandur", active: false },
            { name: "Ulsoor Lake", lat: 12.983, lng: 77.622, id: "ulsoor", active: false }
        ];

        // --- 3. HANDLE INTERACTIONS ---
        const panel = document.getElementById("dashboardPanel");

        function closePanel() {
            panel.classList.remove("panel-visible");
        }

        lakes.forEach(lake => {
            var marker = L.marker([lake.lat, lake.lng]).addTo(map);
            
            marker.bindTooltip(lake.name, {
                permanent: false, 
                direction: 'top'
            });

            marker.on('click', function() {
                panel.classList.add("panel-visible");
                document.getElementById("lakeName").textContent = lake.name;
                resetDataDisplay();

                if (lake.active) {
                    document.getElementById("statusBadge").textContent = "TARGET LOCKED";
                    document.getElementById("statusBadge").style.backgroundColor = "#2980b9";
                    document.getElementById("conclusionText").textContent = "Target acquired. Ready to initiate satellite analysis.";
                    document.getElementById("insightBox").style.display = "block";
                    document.getElementById("analyzeBtn").style.display = "block";
                    document.getElementById("updateBtn").style.display = "block";
                } else {
                    document.getElementById("statusBadge").textContent = "OFFLINE";
                    document.getElementById("statusBadge").style.backgroundColor = "#95a5a6";
                    document.getElementById("conclusionText").textContent = "Telemetry offline. Pipeline under construction.";
                    document.getElementById("insightBox").style.display = "block";
                    document.getElementById("analyzeBtn").style.display = "none";
                    document.getElementById("updateBtn").style.display = "none";
                }

                map.flyTo([lake.lat, lake.lng], 14, { duration: 1.5 });
            });
        });

        function resetDataDisplay() {
            document.getElementById("area").textContent = "---";
            document.getElementById("ndti").textContent = "---";
            document.getElementById("ndci").textContent = "---";
            document.getElementById("mci").textContent = "---";
        }

        // --- 4. BACKEND LOGIC ---
        async function updateSatelliteData() {
            const btn = document.querySelector("#updateBtn");
            const badge = document.getElementById("statusBadge");
            btn.textContent = "Establishing Link...";
            badge.textContent = "DOWNLOADING...";
            badge.style.backgroundColor = "#e67e22"; 

            try {
                const response = await fetch("http://127.0.0.1:8000/update-satellite-data");
                const data = await response.json();
                if (data.status === "success") fetchAnalysis();
                else alert("Error: " + data.message);
            } catch (error) { alert("Signal Lost (Backend Error)"); }
            
            btn.textContent = "Acquire Satellite Link";
        }

        async function fetchAnalysis() {
            const btn = document.querySelector("#analyzeBtn");
            const badge = document.getElementById("statusBadge");
            btn.textContent = "Processing...";
            
            try {
                const response = await fetch("http://127.0.0.1:8000/analyze/hebbal");
                const data = await response.json();

                if (data.error) {
                    badge.textContent = "ERROR";
                } else {
                    document.getElementById("area").textContent = data.area_hectares + " Ha";
                    document.getElementById("lst").textContent = data.avg_lst + " Â°C"; 
                    document.getElementById("ndti").textContent = data.avg_ndti;
                    document.getElementById("ndti").textContent = data.avg_ndti;
                    document.getElementById("ndci").textContent = data.avg_ndci;
                    document.getElementById("mci").textContent = data.avg_mci;

                    badge.textContent = data.status.toUpperCase();
                    
                    let color = "#95a5a6";
                    if (data.status === "Clear") color = "#27ae60";
                    else if (data.status.includes("High")) color = "#e74c3c";
                    else color = "#f1c40f";

                    badge.style.backgroundColor = color;
                    document.getElementById("conclusionText").innerHTML = data.conclusion;
                }
            } catch (error) { console.error(error); }
            btn.textContent = "Initialize Scan";
        }
    </script>

</body>
</html>